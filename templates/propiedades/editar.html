{% extends 'base.html' %}
{% load static %}
{% block title %}Editar Propiedad | ServiTracker{% endblock %}

{% block content %}
<div class="container my-5">
    <h2 class="text-blue-dark">Editar propiedad</h2>
    <form method="post" id="propiedad-form" class="mt-3">
        {% csrf_token %}

        <!-- Dirección -->
        <div class="mb-3">
            {{ form.direccion.label_tag }}
            {{ form.direccion }}
        </div>

        <!-- Select de departamento -->
        <div class="mb-3">
            <label for="departamento">Departamento</label>
            <select id="departamento" name="departamento" class="form-select">
                {% if form.instance.departamento %}
                    <option selected>{{ form.instance.departamento }}</option>
                {% endif %}
            </select>
        </div>

        <!-- Select de ciudad -->
        <div class="mb-3">
            <label for="ciudad">Ciudad</label>
            <select id="ciudad" name="ciudad" class="form-select">
                {% if form.instance.ciudad %}
                    <option selected>{{ form.instance.ciudad }}</option>
                {% endif %}
            </select>
        </div>

        <button type="submit" class="btn btn-blue-mid">Guardar cambios</button>
        <a href="{% url 'lista_propiedades' %}" class="btn btn-secondary">Cancelar</a>
    </form>
</div>

<!-- Script dinámico -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const departamentoSelect = document.getElementById("departamento");
    const ciudadSelect = document.getElementById("ciudad");

    // Valores actuales de la propiedad (para preselección)
    const currentDepartamento = "{{ form.instance.departamento|escapejs }}";
    const currentCiudad = "{{ form.instance.ciudad|escapejs }}";

    // Cargar departamentos y ciudades desde el JSON
    fetch("{% static 'data/colombia.json' %}")
        .then(response => response.json())
        .then(data => {
            data.sort((a, b) => a.departamento.localeCompare(b.departamento));

            // Llenar departamentos
            departamentoSelect.innerHTML = "";
            data.forEach(dep => {
                const option = document.createElement("option");
                option.value = dep.departamento;
                option.textContent = dep.departamento;
                if (dep.departamento === currentDepartamento) {
                    option.selected = true;
                }
                departamentoSelect.appendChild(option);
            });

            // Llenar ciudades según el departamento actual
            function cargarCiudades(depNombre) {
                ciudadSelect.innerHTML = "";
                const dep = data.find(d => d.departamento === depNombre);
                if (dep) {
                    dep.ciudades.forEach(ciudad => {
                        const option = document.createElement("option");
                        option.value = ciudad;
                        option.textContent = ciudad;
                        if (ciudad === currentCiudad) {
                            option.selected = true;
                        }
                        ciudadSelect.appendChild(option);
                    });
                }
            }

            cargarCiudades(currentDepartamento);

            // Cambiar ciudades al seleccionar otro departamento
            departamentoSelect.addEventListener("change", function() {
                cargarCiudades(this.value);
            });
        });
});
</script>
{% endblock %}
