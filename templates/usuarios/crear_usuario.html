{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% block title %}Crear usuario | ServiTracker{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="card shadow-sm">
        <div class="card-header bg-blue-mid text-white text-center">
            <h4 class="mb-0">Crear usuario</h4>
        </div>
        <div class="card-body">
            <form method="post" id="registro-form" class="row g-3">
                {% csrf_token %}

                <!-- Documento -->
                <div class="col-md-6">
                    {{ form.documento.label_tag }}
                    {{ form.documento|add_class:"form-control" }}
                    <small id="doc-error" class="text-danger"></small>
                </div>

                <!-- Nombre -->
                <div class="col-md-6">
                    {{ form.nombres.label_tag }}
                    {{ form.nombres|add_class:"form-control" }}
                </div>

                <!-- Apellido -->
                <div class="col-md-6">
                    {{ form.apellidos.label_tag }}
                    {{ form.apellidos|add_class:"form-control" }}
                </div>

                <!-- Email -->
                <div class="col-md-6">
                    {{ form.email.label_tag }}
                    {{ form.email|add_class:"form-control" }}
                    <small id="email-error" class="text-danger"></small>
                </div>

                <!-- Rol -->
                <div class="col-md-6">
                    {{ form.rol.label_tag }}
                    {{ form.rol|add_class:"form-select" }}
                </div>

                <!-- Contraseña -->
                <div class="col-md-6">
                    {{ form.password1.label_tag }}
                    {{ form.password1|add_class:"form-control" }}
                    <small id="pass1-error" class="text-danger"></small>
                </div>
                <div class="col-md-6">
                    {{ form.password2.label_tag }}
                    {{ form.password2|add_class:"form-control" }}
                    <small id="pass2-error" class="text-danger"></small>
                </div>

                <!-- Campos dinámicos -->
                <div class="col-12" id="ciudadano-fields" style="display:none;">
                    <h5 class="text-blue-mid mt-4">Dirección principal</h5>
                    
                    <!-- Select de departamento -->
                    <div class="mb-3">
                        <label for="departamento">Departamento</label>
                        <select id="departamento" name="departamento" class="form-select"></select>
                    </div>

                    <!-- Select de ciudad -->
                    <div class="mb-3">
                        <label for="ciudad">Ciudad</label>
                        <select id="ciudad" name="ciudad" class="form-select"></select>
                    </div>

                    <!-- Dirección -->
                    <div class="mb-3">
                        <label for="id_direccion" class="form-label">Dirección</label>
                        {{ form.direccion|add_class:"form-control" }}
                        <small id="dir-error" class="text-danger"></small>
                    </div>
                </div>

                <div class="col-12" id="tecnico-fields" style="display:none;">
                    <h5 class="text-blue-mid mt-4">Especialidad</h5>
                    {{ form.especialidad|add_class:"form-select" }}
                    <p class="mt-2">¿No está en la lista? Escríbela aquí:</p>
                    {{ form.nueva_especialidad|add_class:"form-control" }}
                </div>

                <!-- Botones en una sola fila -->
                <div class="row mt-4 g-2">
                    <div class="col-md-6">
                        <button type="submit" class="btn btn-orange-dark w-100 py-3">➕ Crear usuario</button>
                    </div>
                    <div class="col-md-6">
                        <a href="{% url 'lista_usuarios' %}" class="btn btn-secondary w-100 py-3">⬅ Volver</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Script dinámico -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const rolSelect = document.querySelector("#id_rol");
    const ciudadanoFields = document.getElementById("ciudadano-fields");
    const tecnicoFields = document.getElementById("tecnico-fields");
    const form = document.getElementById("registro-form");
    const password1 = document.getElementById("id_password1");
    const password2 = document.getElementById("id_password2");
    const emailInput = document.getElementById("id_email");
    const docInput = document.getElementById("id_documento");
    const direccionInput = document.getElementById("id_direccion");

    const departamentoSelect = document.getElementById("departamento");
    const ciudadSelect = document.getElementById("ciudad");

    function toggleFields() {
        ciudadanoFields.style.display = rolSelect.value === "ciudadano" ? "block" : "none";
        tecnicoFields.style.display = rolSelect.value === "tecnico" ? "block" : "none";
    }

    rolSelect.addEventListener("change", toggleFields);
    toggleFields(); // inicializa al cargar

    // Cargar departamentos y ciudades desde el JSON
    fetch("{% static 'data/colombia.json' %}")
        .then(response => response.json())
        .then(data => {
            data.sort((a, b) => a.departamento.localeCompare(b.departamento));
            data.forEach(dep => {
                const option = document.createElement("option");
                option.value = dep.departamento;
                option.textContent = dep.departamento;
                departamentoSelect.appendChild(option);
            });
            departamentoSelect.addEventListener("change", function() {
                ciudadSelect.innerHTML = "";
                const dep = data.find(d => d.departamento === this.value);
                if (dep) {
                    dep.ciudades.forEach(ciudad => {
                        const option = document.createElement("option");
                        option.value = ciudad;
                        option.textContent = ciudad;
                        ciudadSelect.appendChild(option);
                    });
                    if (dep.ciudades.length > 0) {
                        ciudadSelect.value = dep.ciudades[0];
                    }
                }
            });
        });

    // Validación inmediata (onblur)
    docInput.addEventListener("blur", () => {
        document.getElementById("doc-error").textContent =
            isNaN(docInput.value) ? "El documento debe ser numérico." : "";
    });

    emailInput.addEventListener("blur", () => {
        document.getElementById("email-error").textContent =
            (!emailInput.value.includes("@")) ? "El correo debe contener un @." : "";
    });

    password1.addEventListener("blur", () => {
        document.getElementById("pass1-error").textContent =
            (password1.value.length < 8) ? "La contraseña debe tener al menos 8 caracteres." : "";
    });

    password2.addEventListener("blur", () => {
        document.getElementById("pass2-error").textContent =
            (password1.value !== password2.value) ? "Las contraseñas no coinciden." : "";
    });

    direccionInput.addEventListener("blur", () => {
        if (rolSelect.value === "ciudadano") {
            document.getElementById("dir-error").textContent =
                (!direccionInput.value) ? "La dirección no puede estar vacía." : "";
        }
    });

    // Validación final al enviar
    form.addEventListener("submit", function(e) {
        if (password1 && password1.value.length < 8) {
            alert("La contraseña debe tener al menos 8 caracteres.");
            e.preventDefault();
            return;
        }
        if (password1 && password2 && password1.value !== password2.value) {
            alert("Las contraseñas no coinciden.");
            e.preventDefault();
            return;
        }
        if (rolSelect.value === "ciudadano") {
            if (!departamentoSelect.value) {
                alert("Debes seleccionar un departamento.");
                e.preventDefault();
                return;
            }
            if (!ciudadSelect.value) {
                alert("Debes seleccionar una ciudad.");
                e.preventDefault();
                return;
            }
            if (!direccionInput.value) {
                alert("Debes ingresar una dirección.");
                e.preventDefault();
                return;
            }
        }
    });
});
</script>
{% endblock %}
