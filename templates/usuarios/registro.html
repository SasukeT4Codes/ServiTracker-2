{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% block title %}Registro ciudadano | ServiTracker{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="card shadow-sm">
        <div class="card-header bg-blue-mid text-white text-center">
            <h4 class="mb-0">Registro de ciudadano</h4>
        </div>
        <div class="card-body">
            <form method="post" id="registro-form" class="row g-3">
                {% csrf_token %}

                <!-- Documento -->
                <div class="col-md-6">
                    {{ form.documento.label_tag }}
                    {{ form.documento|add_class:"form-control" }}
                    <small id="doc-error" class="text-danger"></small>
                </div>

                <!-- Nombre -->
                <div class="col-md-6">
                    {{ form.nombres.label_tag }}
                    {{ form.nombres|add_class:"form-control" }}
                </div>

                <!-- Apellido -->
                <div class="col-md-6">
                    {{ form.apellidos.label_tag }}
                    {{ form.apellidos|add_class:"form-control" }}
                </div>

                <!-- Email -->
                <div class="col-md-6">
                    {{ form.email.label_tag }}
                    {{ form.email|add_class:"form-control" }}
                    <small id="email-error" class="text-danger"></small>
                </div>

                <!-- Contrase帽a -->
                <div class="col-md-6">
                    {{ form.password1.label_tag }}
                    {{ form.password1|add_class:"form-control" }}
                    <small id="pass1-error" class="text-danger"></small>
                </div>
                <div class="col-md-6">
                    {{ form.password2.label_tag }}
                    {{ form.password2|add_class:"form-control" }}
                    <small id="pass2-error" class="text-danger"></small>
                </div>

                <!-- Direcci贸n principal -->
                <div class="col-12">
                    <h5 class="text-blue-mid mt-4">Direcci贸n principal</h5>
                    
                    <!-- Select de departamento -->
                    <div class="mb-3">
                        <label for="departamento">Departamento</label>
                        <select id="departamento" name="departamento" class="form-select"></select>
                    </div>

                    <!-- Select de ciudad -->
                    <div class="mb-3">
                        <label for="ciudad">Ciudad</label>
                        <select id="ciudad" name="ciudad" class="form-select"></select>
                    </div>

                    <!-- Direcci贸n -->
                    <div class="mb-3">
                        <label for="id_direccion" class="form-label">Direcci贸n</label>
                        {{ form.direccion|add_class:"form-control" }}
                        <small id="dir-error" class="text-danger"></small>
                    </div>
                </div>

                <!-- Bot贸n de registro -->
                <div class="col-12 mt-4">
                    <button type="submit" class="btn btn-orange-dark w-100 py-3"> Registrarse</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Script din谩mico -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById("registro-form");
    const password1 = document.getElementById("id_password1");
    const password2 = document.getElementById("id_password2");
    const emailInput = document.getElementById("id_email");
    const docInput = document.getElementById("id_documento");
    const direccionInput = document.getElementById("id_direccion");

    const departamentoSelect = document.getElementById("departamento");
    const ciudadSelect = document.getElementById("ciudad");

    // Cargar departamentos y ciudades desde el JSON
    fetch("{% static 'data/colombia.json' %}")
        .then(response => response.json())
        .then(data => {
            data.sort((a, b) => a.departamento.localeCompare(b.departamento));
            data.forEach(dep => {
                const option = document.createElement("option");
                option.value = dep.departamento;
                option.textContent = dep.departamento;
                departamentoSelect.appendChild(option);
            });
            departamentoSelect.addEventListener("change", function() {
                ciudadSelect.innerHTML = "";
                const dep = data.find(d => d.departamento === this.value);
                if (dep) {
                    dep.ciudades.forEach(ciudad => {
                        const option = document.createElement("option");
                        option.value = ciudad;
                        option.textContent = ciudad;
                        ciudadSelect.appendChild(option);
                    });
                    if (dep.ciudades.length > 0) {
                        ciudadSelect.value = dep.ciudades[0];
                    }
                }
            });
        });

    // Validaci贸n inmediata (onblur)
    docInput.addEventListener("blur", () => {
        document.getElementById("doc-error").textContent =
            isNaN(docInput.value) ? "El documento debe ser num茅rico." : "";
    });

    emailInput.addEventListener("blur", () => {
        document.getElementById("email-error").textContent =
            (!emailInput.value.includes("@")) ? "El correo debe contener un @." : "";
    });

    password1.addEventListener("blur", () => {
        document.getElementById("pass1-error").textContent =
            (password1.value.length < 8) ? "La contrase帽a debe tener al menos 8 caracteres." : "";
    });

    password2.addEventListener("blur", () => {
        document.getElementById("pass2-error").textContent =
            (password1.value !== password2.value) ? "Las contrase帽as no coinciden." : "";
    });

    direccionInput.addEventListener("blur", () => {
        document.getElementById("dir-error").textContent =
            (!direccionInput.value) ? "La direcci贸n no puede estar vac铆a." : "";
    });

    // Validaci贸n final al enviar
    form.addEventListener("submit", function(e) {
        if (password1 && password1.value.length < 8) {
            alert("La contrase帽a debe tener al menos 8 caracteres.");
            e.preventDefault();
            return;
        }
        if (password1 && password2 && password1.value !== password2.value) {
            alert("Las contrase帽as no coinciden.");
            e.preventDefault();
            return;
        }
        if (!departamentoSelect.value) {
            alert("Debes seleccionar un departamento.");
            e.preventDefault();
            return;
        }
        if (!ciudadSelect.value) {
            alert("Debes seleccionar una ciudad.");
            e.preventDefault();
            return;
        }
        if (!direccionInput.value) {
            alert("Debes ingresar una direcci贸n.");
            e.preventDefault();
            return;
        }
    });
});
</script>
{% endblock %}
